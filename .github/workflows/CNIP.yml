name: Publish CNIP to Release

on:
  schedule:
    # 北京时间每天中午 12:00 (UTC 4:00) 运行
    - cron: '0 4 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate cnip.rsc
        run: |
          # 定义文件名
          FILE="cnip.rsc"

          echo "Generating ROS script..."

          # 1. 写入头部 (进入菜单，清除旧列表)
          echo "/ip firewall address-list" > $FILE
          echo "remove [find list=CNIP]" >> $FILE

          # 2. 写入私有网段 (注意：Comment必须加双引号，否则ROS会报错)
          echo 'add list=CNIP address=192.168.0.0/16 comment="private-network"' >> $FILE
          echo 'add list=CNIP address=10.0.0.0/8 comment="private-network"' >> $FILE
          echo 'add list=CNIP address=172.16.0.0/12 comment="private-network"' >> $FILE
          echo 'add list=CNIP address=100.64.0.0/10 comment="ISP-CGNAT"' >> $FILE

          # 3. 下载 hackl0us 纯净 IP 库并转换格式
          # 使用 curl 下载，awk 拼接字符串
          curl -sL https://github.com/Hackl0us/GeoIP2-CN/raw/release/CN-ip-cidr.txt | \
          awk '{print "add list=CNIP address="$1}' >> $FILE

          echo "File generated successfully."

      - name: Get Beijing Date
        run: |
          # 获取北京时间并写入环境变量 DATE
          echo "DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "DATE_SHORT=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Commit and Push
        run: |
        
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add cnip.rsc
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update CNIP list: ${{ env.DATE }}"
            git push
          fi

      - name: Upload to Release
        uses: ncipollo/release-action@v1
        with:
          # 固定 Tag 名称，保证 ROS 下载链接不变
          tag: cnip
          name: "Auto Updated CNIP List"
          # 引用日期变量
          body: "Updated on ${{ env.DATE }} (Beijing Time)"
          artifacts: "cnip.rsc"
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
